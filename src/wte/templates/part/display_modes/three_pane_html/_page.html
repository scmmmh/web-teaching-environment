<article class="rows" xmlns:py="http://genshi.edgewall.org/">
  <section id="textbook" class="small-12 medium-6 large-4 column">
    <div py:if="part.allow('edit', r.current_user) or part.allow('delete', r.current_user)" class="right" data-wte-menu-position="right">
      ${h.frontend.menubar([
        {'group': 'edit', 'items': [
          {'visible': part.allow('edit', r.current_user),
           'icon': 'fi-pencil',
           'label': 'Edit',
           'href': r.route_url('part.edit', pid=part.id),
           'highlight': True}]},
        {'group': 'importexport', 'items': [
          {'visible': part.allow('edit', r.current_user),
           'label': 'Export',
           'href': r.route_url('part.export', pid=part.id),
           'class': 'post-link'}]},
        {'group': 'delete', 'items': [
          {'visible': part.allow('delete', r.current_user),
           'label': 'Delete',
           'href': r.route_url('part.delete', pid=part.id),
           'class': 'alert post-link',
           'confirm': h.frontend.confirm_delete(part.type, part.title, True)}]},
      ], drop_down_menu_left=False)}
    </div>
    <h1>${part.title}<small py:if="part.status == 'unavailable'" class="label radius">Unavailable</small></h1>
    ${Markup(part.compiled_content)}
    <div class="pagination-centered">
      ${h.frontend.page_pagination(r, part)}
    </div>
  </section>
  <section id="editor" class="small-12 medium-6 large-8">
    <section id="files">
      <div class="right">
        ${h.frontend.menubar([
          {'group': 'download', 'items': [
            {'visible': True,
             'label': 'Download the Workspace',
             'href': r.route_url('userpartprogress.download', uid=r.current_user.id, pid=progress.id)}]},
          {'group': 'reset', 'items': [
            {'visible': True,
             'label': 'Discard all Changes',
             'href': r.route_url('part.reset-files', pid=part.id),
             'class': 'alert post-link',
             'confirm': h.frontend.confirm_action('Discard all Changes', 'Please confirm that you wish to discard all the changes you made to the files and reset them to their initial content.', "Don't Discard", {'label': 'Discard', 'class_': 'alert'})}]}
        ], class_='margin-top-right')}
      </div>
      <dl class="tabs" data-tab="">
        <dd py:for="idx, file in enumerate(progress.files)" id="${h.frontend.html_id(file.filename)}-tab" class="${'active' if idx == 0 else ''}">
          <div class="right">
            ${h.frontend.menubar([
              {'group': 'download', 'items': [
                {'visible': True,
                 'label': 'Download',
                 'href': r.route_url('file.view', pid=part.id, filename=file.filename, _query=[('download', 'true')])}]},
              {'group': 'reset', 'items': [
                {'visible': True,
                 'label': 'Discard Changes',
                 'href': r.route_url('part.reset-files', pid=part.id, _query=[('filename', file.filename)]),
                 'class': 'alert post-link',
                 'confirm': h.frontend.confirm_action('Discard Changes', 'Please confirm that you wish to discard the changes you made to the file "%s" and reset it to its initial content.' % (file.filename), "Don't Discard", {'label': 'Discard', 'class_': 'alert'})}]}
            ], class_='margin-top-right')}
          </div>
          <a href="#${h.frontend.html_id(file.filename)}"><img src="${r.static_url('wte:static/img/spinner-small.gif')}" class="hidden"/> ${file.filename}</a>
        </dd>
      </dl>
      <form class="tabs-content">
        <div py:for="idx, file in enumerate(progress.files)" class="content ${'active' if idx == 0 else ''}" id="${h.frontend.html_id(file.filename)}">
          ${h.form.tags.textarea('', file.data.decode('utf-8') if file.data else '', None, data_wte_mimetype=file.mimetype, data_wte_fileid=file.id, data_wte_cm_options=h.frontend.codemirror_options(file.mimetype))}
        </div>
      </form>
    </section>
    <section id="viewer">
      <div class="view-options">
        <div class="right">
          ${h.frontend.menubar([
            #{'group': 'options', 'items': [
            #  {'visible': True,
            #   'label': 'Reload',
            #   'icon': 'fi-loop',
            #   'href': '#',
            #   'class': '',
            #   'highlight': True}]},
            {'group': 'options', 'items': [
              {'visible': True,
               'label': 'Open in new Tab / Window',
               'href': r.route_url('file.view', pid=part.id, filename=h.frontend.primary_filename(progress)),
               'target': 'wte_fullscreen'}]}
          ])}
        </div>
      </div>
      <iframe src="${r.route_url('file.view', pid=part.id, filename=h.frontend.primary_filename(progress))}"></iframe>
    </section>
  </section>
    ${h.frontend.codemirror_scripts(r, [f.mimetype for f in progress.files])}
    <script>
    function resize_page() {
        var win_height = $(window).innerHeight();
        $('nav.top-bar').each(function() {
            win_height = win_height - $(this).outerHeight(true);
        });
        $('#textbook').css('height', win_height + 'px');
        $('#editor').css('height', win_height + 'px');
        $('#files').css('height', (win_height / 2) + 'px');
        $('#files .content').each(function() {
            $(this).css('height', (win_height / 2) - $('#files .tabs').outerHeight(true) + 'px');
        });
        $('#viewer').css('height', (win_height / 2) + 'px');
    }
    $(document).ready(function() {
        resize_page();
        setTimeout(function() {
            resize_page();
        }, 100);
        setTimeout(function() {
            resize_page();
        }, 500);
        setTimeout(function() {
            resize_page();
        }, 1000);
        $(window).on('resize', resize_page);
        $('#files').tabbedEditor({
        	viewer: $('#viewer iframe'),
        	save_url: '${r.route_url('file.save', pid=part.id, fid='FID')}'
        });
        $('.menu').dropdownMenu();
    });
    </script>
</article>