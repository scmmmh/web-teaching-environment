<article class="rows" xmlns:py="http://genshi.edgewall.org/">
  <section id="editor" class="small-12 medium-12 large-12">
    <section id="files">
      <div class="right">
        ${h.frontend.menubar([
          {'group': 'download', 'items': [
            {'visible': True,
             'label': 'Download the Project',
             'href': r.route_url('userpartprogress.download', uid=r.current_user.id, pid=progress.id)}]},
          {'group': 'edit', 'items': [
            {'visible': part.allow('edit', r.current_user),
             'icon': 'fi-pencil',
             'label': 'Edit',
             'href': r.route_url('part.edit', pid=part.id),
             'highlight': True}]},
          {'group': 'add', 'items': [
            {'visible': part.allow('edit', r.current_user),
             'label': 'Add File',
             'icon': 'fi-plus',
             'href': r.route_url('asset.new', pid=part.id, new_type='file'),
             'highlight': True},
            {'visible': part.allow('edit', r.current_user),
             'label': 'Add Asset',
             'icon': 'fi-plus',
             'href': r.route_url('asset.new', pid=part.id, new_type='asset'),
             'highlight': True}]},
          {'group': 'delete', 'items': [
            {'visible': part.allow('delete', r.current_user),
             'label': 'Delete',
             'href': r.route_url('part.delete', pid=part.id),
             'class': 'alert post-link',
             'confirm': h.frontend.confirm_delete(part.type, part.title, False)}]},
        ], class_='margin-top-right')}
      </div>
      <dl class="tabs" data-tab="">
        <dd py:for="idx, file in enumerate(progress.files)" id="${h.frontend.html_id(file.filename)}-tab" class="${'active' if idx == 0 else ''}">
          <div class="right">
            ${h.frontend.menubar([
              {'group': 'download', 'items': [
                {'visible': True,
                 'label': 'Download',
                 'href': r.route_url('file.view', pid=part.id, filename=file.filename, _query=[('download', 'true')])}]},
              {'group': 'reset', 'items': [
                {'visible': True,
                 'label': 'Delete',
                 'href': r.route_url('part.reset-files', pid=part.id, _query=[('filename', file.filename)]),
                 'class': 'alert post-link',
                 'confirm': h.frontend.confirm_action('Delete File', 'Please confirm that you wish to delete the file "%s".' % (file.filename), "Don't Delete", {'label': 'Delete', 'class_': 'alert'})}]}
            ], class_='margin-top-right')}
          </div>
          <a href="#${h.frontend.html_id(file.filename)}"><img src="${r.static_url('wte:static/img/spinner-small.gif')}" class="hidden"/> ${file.filename}</a>
        </dd>
        <dd py:for="idx, file in enumerate(part.assets)" id="asset-${file.id}-tab" class="${'active' if idx == 0 and not progress.files else ''}">
          <div class="right">
            ${h.frontend.menubar([
              {'group': 'edit', 'items': [
                {'visible': True,
                 'label': 'Download',
                 'href': r.route_url('file.view', pid=part.id, filename='assets/%s' % (file.filename), _query=[('download', 'true')])}]},
              {'group': 'delete', 'items': [
                {'visible': True,
                 'label': 'Delete',
                 'href': r.route_url('asset.delete', pid=part.id, aid=file.id),
                 'class': 'alert post-link',
                 'confirm': h.frontend.confirm_delete('asset', file.filename, False)}]},
            ], class_='margin-top-right')}
          </div>
          <a href="#asset-${file.id}"><img src="${r.static_url('wte:static/img/spinner-small.gif')}" class="hidden"/> ${file.filename}</a>
        </dd>
      </dl>
      <form class="tabs-content">
        <div py:for="idx, file in enumerate(progress.files)" class="content ${'active' if idx == 0 else ''}" id="${h.frontend.html_id(file.filename)}">
          ${h.form.tags.textarea('', file.data.decode('utf-8') if file.data else '', None, data_wte_mimetype=file.mimetype, data_wte_fileid=file.id)}
        </div>
        <div py:for="idx, file in enumerate(part.assets)" class="content ${'active' if idx == 0 and not progress.files else ''}" id="asset-${file.id}">
          <img py:if="file.mimetype.startswith('image/')" src="${r.route_url('file.view', pid=part.id, filename='assets/%s' % (file.filename))}"/>
        </div>
      </form>
    </section>
    <section id="viewer">
      <div class="view-options">
        <div class="right">
          ${h.frontend.menubar([
            #{'group': 'options', 'items': [
            #  {'visible': True,
            #   'label': 'Reload',
            #   'icon': 'fi-loop',
            #   'href': '#',
            #   'class': '',
            #   'highlight': True}]},
            {'group': 'options', 'items': [
              {'visible': True,
               'label': 'Open in new Tab / Window',
               'href': r.route_url('file.view', pid=part.id, filename=h.frontend.primary_filename(progress)),
               'target': 'wte_fullscreen'}]}
          ])}
        </div>
      </div>
      <iframe src="${r.route_url('file.view', pid=part.id, filename=h.frontend.primary_filename(progress))}"></iframe>
    </section>
  </section>
    <script src="${r.static_url('wte:static/js/codemirror/codemirror.js')}"></script>
    ${h.frontend.codemirror_scripts(r, [f.mimetype for f in progress.files])}
    <script>
    function resize_page() {
        var win_height = $(window).innerHeight();
        $('nav.top-bar').each(function() {
            win_height = win_height - $(this).outerHeight(true);
        });
        $('#textbook').css('height', win_height + 'px');
        $('#editor').css('height', win_height + 'px');
        $('#files').css('height', (win_height / 2) + 'px');
        $('#files .content').each(function() {
            $(this).css('height', (win_height / 2) - $('#files .tabs').outerHeight(true) + 'px');
        });
        $('#viewer').css('height', (win_height / 2) + 'px');
    }
    $(document).ready(function() {
        resize_page();
        $(window).on('resize', resize_page);
        $('#files').tabbedEditor({
            viewer: $('#viewer iframe'),
            save_url: '${r.route_url('file.save', pid=part.id, fid='FID')}'
        });
        $('.menu').dropdownMenu();
    });
    </script>
</article>