<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="../../../../static/css/application.min.css"/>
    <link rel="stylesheet" href="../../../_static/default.css"/>
    <link rel="stylesheet" href="../../../_static/override.css"/>
    <link rel="stylesheet" href="../../../_static/pygments.css"/>
    <title>wte.views.user</title>
  </head>
  <body class="help">
    <nav>
      <ul class="breadcrumbs">
        <li><a href="../../../index.html">Home</a></li>
        
          <li><a href="../../index.html">Module code</a></li>
        
          <li><a href="../../wte.html">wte</a></li>
        
          <li><a href="../views.html">wte.views</a></li>
        
        <li>wte.views.user</li>
      </ul>
      <div class="row">
        <div class="column small-12">
          <h1>Source code for wte.views.user</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">#########################################################</span>
<span class="sd">:mod:`wte.views.user` -- User functionality view handlers</span>
<span class="sd">#########################################################</span>

<span class="sd">The :mod:`~wte.views.user` module handles all user functionality.</span>

<span class="sd">Routes are defined in :func:`~wte.views.user.init`.</span>

<span class="sd">.. moduleauthor:: Mark Hall &lt;mark.hall@work.room3b.eu&gt;</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">formencode</span>
<span class="kn">import</span> <span class="nn">transaction</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">pyramid.httpexceptions</span> <span class="kn">import</span> <span class="p">(</span><span class="n">HTTPSeeOther</span><span class="p">,</span> <span class="n">HTTPNotFound</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pyramid.view</span> <span class="kn">import</span> <span class="n">view_config</span>
<span class="kn">from</span> <span class="nn">pywebtools.formencode</span> <span class="kn">import</span> <span class="n">State</span><span class="p">,</span> <span class="n">CSRFSchema</span><span class="p">,</span> <span class="n">UniqueEmailValidator</span><span class="p">,</span> <span class="n">EmailDomainValidator</span>
<span class="kn">from</span> <span class="nn">pywebtools.pyramid</span> <span class="kn">import</span> <span class="n">auth</span> <span class="k">as</span> <span class="n">pyramid_auth</span>
<span class="kn">from</span> <span class="nn">pywebtools.pyramid.auth.models</span> <span class="kn">import</span> <span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">PermissionGroup</span><span class="p">,</span> <span class="n">TimeToken</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">pywebtools.pyramid.auth.views</span> <span class="kn">import</span> <span class="n">current_user</span>
<span class="kn">from</span> <span class="nn">pywebtools.sqlalchemy</span> <span class="kn">import</span> <span class="n">DBSession</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">or_</span>

<span class="kn">from</span> <span class="nn">wte.decorators</span> <span class="kn">import</span> <span class="p">(</span><span class="n">require_logged_in</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">wte.util</span> <span class="kn">import</span> <span class="p">(</span><span class="n">unauthorised_redirect</span><span class="p">,</span> <span class="n">send_email</span><span class="p">,</span> <span class="n">get_config_setting</span><span class="p">,</span>
                      <span class="n">paginate</span><span class="p">)</span>


<div class="viewcode-block" id="init"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.init">[docs]</a><span class="k">def</span> <span class="nf">init</span><span class="p">(</span><span class="n">config</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Adds the user-specific routes (route name, URL pattern, handler):</span>

<span class="sd">    * ``users`` -- ``/users`` -- :func:`~wte.views.user.users`</span>
<span class="sd">    * ``users.action`` -- ``/users/action`` -- :func:`~wte.views.user.action`</span>
<span class="sd">    * ``user.view`` -- ``/users/{uid}`` -- :func:`~wte.views.user.view`</span>
<span class="sd">    * ``user.edit`` -- ``/users/{uid}/edit`` -- :func:`~wte.views.user.edit`</span>
<span class="sd">    * ``user.permissions`` -- ``/users/{uid}/permissions`` --</span>
<span class="sd">      :func:`~wte.views.user.permissions`</span>
<span class="sd">    * ``user.delete`` -- ``/users/{uid}/delete`` --</span>
<span class="sd">      :func:`~wte.views.user.delete`</span>

<span class="sd">    Also initialises the :mod:`pywebtools.pyramid.auth` authentication system</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pyramid_auth</span><span class="o">.</span><span class="n">init</span><span class="p">(</span><span class="n">config</span><span class="p">,</span>
                      <span class="n">renderers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user.login&#39;</span><span class="p">:</span> <span class="s1">&#39;wte:templates/users/login.kajiki&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.logout&#39;</span><span class="p">:</span> <span class="s1">&#39;wte:templates/users/logout.kajiki&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.register&#39;</span><span class="p">:</span> <span class="s1">&#39;wte:templates/users/register.kajiki&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.confirm&#39;</span><span class="p">:</span> <span class="s1">&#39;wte:templates/users/confirm.kajiki&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.forgotten_password&#39;</span><span class="p">:</span> <span class="s1">&#39;wte:templates/users/forgotten_password.kajiki&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.reset_password&#39;</span><span class="p">:</span> <span class="s1">&#39;wte:templates/users/reset_password.kajiki&#39;</span><span class="p">},</span>
                      <span class="n">redirects</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;_default&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.login&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;route&#39;</span><span class="p">:</span> <span class="s1">&#39;part.list&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;_query&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;{uid}&#39;</span><span class="p">}}},</span>
                                 <span class="s1">&#39;user.logout&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.register&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.forgotten_password&#39;</span><span class="p">:</span> <span class="s1">&#39;root&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;user.reset_password&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;route&#39;</span><span class="p">:</span> <span class="s1">&#39;part.list&#39;</span><span class="p">,</span>
                                                         <span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;_query&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;user_id&#39;</span><span class="p">:</span> <span class="s1">&#39;{uid}&#39;</span><span class="p">}}}},</span>
                      <span class="n">callbacks</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;user.created&#39;</span><span class="p">:</span> <span class="n">new_user_created</span><span class="p">,</span>
                                 <span class="s1">&#39;user.validated&#39;</span><span class="p">:</span> <span class="n">new_user_validated</span><span class="p">,</span>
                                 <span class="s1">&#39;user.password_reset&#39;</span><span class="p">:</span> <span class="n">password_reset</span><span class="p">,</span>
                                 <span class="s1">&#39;user.password_reset_failed&#39;</span><span class="p">:</span> <span class="n">password_reset_failed</span><span class="p">,</span>
                                 <span class="s1">&#39;user.password_reset_complete&#39;</span><span class="p">:</span> <span class="n">password_reset_complete</span><span class="p">})</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="s1">&#39;/users&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;users.action&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/action&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/{uid}&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;user.edit&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/{uid}/edit&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;user.permissions&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/{uid}/permissions&#39;</span><span class="p">)</span>
    <span class="n">config</span><span class="o">.</span><span class="n">add_route</span><span class="p">(</span><span class="s1">&#39;user.delete&#39;</span><span class="p">,</span> <span class="s1">&#39;/users/{uid}/delete&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="new_user_created"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.new_user_created">[docs]</a><span class="k">def</span> <span class="nf">new_user_created</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Callback that sends an e-mail to the newly created user&#39;s e-mail address</span>
<span class="sd">    to give them a validation link.</span>

<span class="sd">    :param request: The request to use for configuration settings</span>
<span class="sd">    :type request: :class:`~pyramid.request.Request`</span>
<span class="sd">    :param user: The user to send the e-mail to</span>
<span class="sd">    :type user: :class:`~pywebtools.pyramid.auth.models.User`</span>
<span class="sd">    :param token: The validation token</span>
<span class="sd">    :type token: :class:`~pywebtools.pyramid.auth.models.TimeToken`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flash</span><span class="p">(</span><span class="s1">&#39;A confirmation e-mail has been sent to the e-mail address you provided.&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
    <span class="n">send_email</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
               <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
               <span class="n">get_config_setting</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;email.sender&#39;</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="s1">&#39;no-reply@example.com&#39;</span><span class="p">),</span>
               <span class="s1">&#39;Please confirm your registration&#39;</span><span class="p">,</span>
               <span class="sd">&#39;&#39;&#39;Hello %s,</span>

<span class="sd">Thank you for registering with the Web Teaching Environment. To complete your</span>
<span class="sd">registration, please click on the following link or copy it into your browser:</span>

<span class="sd">%s</span>

<span class="sd">This link is valid for 60 minutes. If you do not confirm your registration within</span>
<span class="sd">that time, you will need to use the &quot;Forgotten Password&quot; function to request a new</span>
<span class="sd">confirmation link.</span>

<span class="sd">Best Regards,</span>
<span class="sd">Web Teaching Environment&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                               <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.confirm&#39;</span><span class="p">,</span>
                                                 <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">token</span><span class="p">)))</span></div>


<div class="viewcode-block" id="new_user_validated"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.new_user_validated">[docs]</a><span class="k">def</span> <span class="nf">new_user_validated</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Callback that sends an e-mail to the newly created user&#39;s e-mail address</span>
<span class="sd">    to give them a password-reset link.</span>

<span class="sd">    :param request: The request to use for configuration settings</span>
<span class="sd">    :type request: :class:`~pyramid.request.Request`</span>
<span class="sd">    :param user: The user to send the e-mail to</span>
<span class="sd">    :type user: :class:`~pywebtools.pyramid.auth.models.User`</span>
<span class="sd">    :param token: The validation token</span>
<span class="sd">    :type token: :class:`~pywebtools.pyramid.auth.models.TimeToken`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">send_email</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
               <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
               <span class="n">get_config_setting</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;email.sender&#39;</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="s1">&#39;no-reply@example.com&#39;</span><span class="p">),</span>
               <span class="s1">&#39;Registration for the Web Teaching Environment Complete&#39;</span><span class="p">,</span>
               <span class="sd">&#39;&#39;&#39;Hello %s,</span>

<span class="sd">Thank you for completing the registration process. To log in, please</span>
<span class="sd">click on the following link and set a new password:</span>

<span class="sd">%s</span>

<span class="sd">The link is valid for 20 minutes. If you do not set a password within that time,</span>
<span class="sd">you will need to use the &quot;Forgotten Password&quot; function to request a new confirmation</span>
<span class="sd">link.</span>

<span class="sd">Best Regards,</span>
<span class="sd">Web Teaching Environment&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.reset_password&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">token</span><span class="p">)))</span></div>


<div class="viewcode-block" id="password_reset"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.password_reset">[docs]</a><span class="k">def</span> <span class="nf">password_reset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Callback that sends an e-mail to the user&#39;s e-mail address with a</span>
<span class="sd">    link to reset their password.</span>

<span class="sd">    :param request: The request to use for configuration settings</span>
<span class="sd">    :type request: :class:`~pyramid.request.Request`</span>
<span class="sd">    :param user: The user to send the e-mail to</span>
<span class="sd">    :type user: :class:`~pywebtools.pyramid.auth.models.User`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flash</span><span class="p">(</span><span class="s1">&#39;A password reset link has been sent to the e-mail address you provided.&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
    <span class="n">send_email</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
               <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
               <span class="n">get_config_setting</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;email.sender&#39;</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="s1">&#39;no-reply@example.com&#39;</span><span class="p">),</span>
               <span class="s1">&#39;Password for the Web Teaching Environment reset&#39;</span><span class="p">,</span>
               <span class="sd">&#39;&#39;&#39;Hello %s,</span>

<span class="sd">You have asked to have your password reset. To complete the reset password</span>
<span class="sd">click on the following link or copy it into your browser:</span>

<span class="sd">%s</span>

<span class="sd">The link is valid for 20 minutes. If you do not set a password within that time,</span>
<span class="sd">you will need to use the &quot;Forgotten Password&quot; function to request a new confirmation</span>
<span class="sd">link.</span>

<span class="sd">If you did not ask for your password to be reset, then please check that</span>
<span class="sd">nobody else has access to your e-mail account and might be trying to</span>
<span class="sd">access your Web Teaching Environment account.</span>

<span class="sd">Best Regards,</span>
<span class="sd">Web Teaching Environment&#39;&#39;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.reset_password&#39;</span><span class="p">,</span> <span class="n">token</span><span class="o">=</span><span class="n">token</span><span class="o">.</span><span class="n">token</span><span class="p">)))</span></div>


<div class="viewcode-block" id="password_reset_failed"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.password_reset_failed">[docs]</a><span class="k">def</span> <span class="nf">password_reset_failed</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Callback that handles a failed password reset.&quot;&quot;&quot;</span>
    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flash</span><span class="p">(</span><span class="s1">&#39;A password reset link has been sent to the e-mail address you provided.&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="password_reset_complete"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.password_reset_complete">[docs]</a><span class="k">def</span> <span class="nf">password_reset_complete</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Callback that sends an e-mail to the user&#39;s e-mail address letting them</span>
<span class="sd">    know that their password has been reset.</span>

<span class="sd">    :param request: The request to use for configuration settings</span>
<span class="sd">    :type request: :class:`~pyramid.request.Request`</span>
<span class="sd">    :param user: The user to send the e-mail to</span>
<span class="sd">    :type user: :class:`~pywebtools.pyramid.auth.models.User`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">send_email</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
               <span class="n">user</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
               <span class="n">get_config_setting</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s1">&#39;email.sender&#39;</span><span class="p">,</span>
                                  <span class="n">default</span><span class="o">=</span><span class="s1">&#39;no-reply@example.com&#39;</span><span class="p">),</span>
               <span class="s1">&#39;Reset your password for the Web Teaching Environment&#39;</span><span class="p">,</span>
               <span class="sd">&#39;&#39;&#39;Hello %s,</span>

<span class="sd">You have just reset your password for the Web Teaching Environment.</span>

<span class="sd">If you have not done so, then please contact your administrator as soon as</span>
<span class="sd">possible as somebody else may have gained access to your account.</span>

<span class="sd">Best Regards,</span>
<span class="sd">Web Teaching Environment&#39;&#39;&#39;</span> <span class="o">%</span> <span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span></div>


<div class="viewcode-block" id="create_user_crumbs"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.create_user_crumbs">[docs]</a><span class="k">def</span> <span class="nf">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">crumbs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the base-list of breadcrumbs, depending on the current</span>
<span class="sd">    users authorisation level.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;admin.users.view&#39;</span><span class="p">):</span>
        <span class="n">crumbs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Users&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">)})</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">):</span>
        <span class="n">crumbs</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Administration&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">)})</span>
    <span class="n">crumbs</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s1">&#39;current&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">return</span> <span class="n">crumbs</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;wte:templates/users/list.kajiki&#39;</span><span class="p">)</span>
<span class="nd">@current_user</span><span class="p">()</span>
<div class="viewcode-block" id="users"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.users">[docs]</a><span class="k">def</span> <span class="nf">users</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles the ``/users`` URL, displaying all users if the current</span>
<span class="sd">    :class:`~wte.models.User` has the &quot;admin.users.view&quot;</span>
<span class="sd">    :class:`~wte.models.Permission`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;admin.users.view&#39;</span><span class="p">):</span>
        <span class="n">dbsession</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span>
        <span class="n">query_params</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;q&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]:</span>
            <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">display_name</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]),</span>
                                     <span class="n">User</span><span class="o">.</span><span class="n">email</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">])))</span>
            <span class="n">query_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="s1">&#39;status&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]:</span>
            <span class="n">query_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;confirmed&#39;</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">status</span> <span class="o">!=</span> <span class="s1">&#39;active&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="s1">&#39;start&#39;</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">display_name</span><span class="p">)</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">users</span><span class="o">.</span><span class="n">offset</span><span class="p">(</span><span class="n">start</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
        <span class="n">pages</span> <span class="o">=</span> <span class="n">paginate</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">users</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">query_params</span><span class="o">=</span><span class="n">query_params</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">users</span><span class="p">,</span>
                <span class="s1">&#39;pages&#39;</span><span class="p">:</span> <span class="n">pages</span><span class="p">,</span>
                <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">[])}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unauthorised_redirect</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>


<div class="viewcode-block" id="ActionSchema"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.ActionSchema">[docs]</a><span class="k">class</span> <span class="nc">ActionSchema</span><span class="p">(</span><span class="n">CSRFSchema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The :class:`~wte.views.user.ActionSchema` handles the validation of</span>
<span class="sd">    user action requests.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">action</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">All</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">UnicodeString</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">),</span>
                            <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">OneOf</span><span class="p">([</span><span class="s1">&#39;validate&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="s1">&#39;delete&#39;</span><span class="p">]))</span>
    <span class="sd">&quot;&quot;&quot;The action to apply&quot;&quot;&quot;</span>
    <span class="n">confirm</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">StringBool</span><span class="p">(</span><span class="n">if_empty</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Whether the user has confirmed the action&quot;&quot;&quot;</span>
    <span class="n">user_id</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">ForEach</span><span class="p">(</span><span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Int</span><span class="p">(),</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;User ids to apply the action to&quot;&quot;&quot;</span>
    <span class="n">q</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">UnicodeString</span><span class="p">(</span><span class="n">if_empty</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Optional query parameter for the redirect&quot;&quot;&quot;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">UnicodeString</span><span class="p">(</span><span class="n">if_empty</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Optional status parameter for the redirect&quot;&quot;&quot;</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">UnicodeString</span><span class="p">(</span><span class="n">if_empty</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">if_missing</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Optional start parameter for the redirect&quot;&quot;&quot;</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;users.action&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;wte:templates/users/action.kajiki&#39;</span><span class="p">)</span>
<span class="nd">@current_user</span><span class="p">()</span>
<div class="viewcode-block" id="action"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.action">[docs]</a><span class="k">def</span> <span class="nf">action</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles the ``/users/action`` URL, applying the given action to the</span>
<span class="sd">    list of selected users. Requires that the current</span>
<span class="sd">    :class:`~wte.models.User` has the &quot;admin.users.view&quot;</span>
<span class="sd">    :class:`~wte.models.Permission`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;admin.users.view&#39;</span><span class="p">):</span>
        <span class="n">dbsession</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">query_params</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">param</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;q&#39;</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">,</span> <span class="s1">&#39;start&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">param</span> <span class="ow">in</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span> <span class="ow">and</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]:</span>
                    <span class="n">query_params</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">param</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">param</span><span class="p">]))</span>
            <span class="n">params</span> <span class="o">=</span> <span class="n">ActionSchema</span><span class="p">()</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                              <span class="n">State</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;delete&#39;</span> <span class="ow">or</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;confirm&#39;</span><span class="p">]:</span>
                <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])):</span>
                        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;validate&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;unconfirmed&#39;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="p">):</span>
                                <span class="n">user</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;active&#39;</span>
                        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;delete&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="p">):</span>
                                <span class="n">dbsession</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;action&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;password&#39;</span><span class="p">:</span>
                            <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">&#39;active&#39;</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="p">):</span>
                                <span class="n">token</span> <span class="o">=</span> <span class="n">TimeToken</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                  <span class="s1">&#39;reset_password&#39;</span><span class="p">,</span>
                                                  <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mi">1200</span><span class="p">))</span>
                                <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
                                <span class="n">dbsession</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
                                <span class="n">password_reset</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">token</span><span class="p">)</span>
                <span class="k">raise</span> <span class="n">HTTPSeeOther</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">_query</span><span class="o">=</span><span class="n">query_params</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;params&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">,</span>
                        <span class="s1">&#39;users&#39;</span><span class="p">:</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;user_id&#39;</span><span class="p">])),</span>
                        <span class="s1">&#39;query_params&#39;</span><span class="p">:</span> <span class="n">query_params</span><span class="p">,</span>
                        <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Confirm&#39;</span><span class="p">,</span>
                                                                <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">current_route_url</span><span class="p">()}])}</span>
        <span class="k">except</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flash</span><span class="p">(</span><span class="s1">&#39;Please select the action you wish to apply and the users to apply it to&#39;</span><span class="p">,</span>
                                  <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;error&#39;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">HTTPSeeOther</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">_query</span><span class="o">=</span><span class="n">query_params</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unauthorised_redirect</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;wte:templates/users/view.kajiki&#39;</span><span class="p">)</span>
<span class="nd">@current_user</span><span class="p">()</span>
<span class="nd">@require_logged_in</span><span class="p">()</span>
<div class="viewcode-block" id="view"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.view">[docs]</a><span class="k">def</span> <span class="nf">view</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles the &quot;/users/{uid}&quot; URL, showing the user&#39;s profile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s1">&#39;view&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                    <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                                            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)}]),</span>
                    <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;profile.html&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unauthorised_redirect</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span></div>


<div class="viewcode-block" id="EditSchema"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.EditSchema">[docs]</a><span class="k">class</span> <span class="nc">EditSchema</span><span class="p">(</span><span class="n">CSRFSchema</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class:`~wte.views.user.EditSchema` handles the validation of</span>
<span class="sd">    changes to the :class:`~wte.models.User`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">email</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">All</span><span class="p">(</span><span class="n">UniqueEmailValidator</span><span class="p">(),</span>
                           <span class="n">EmailDomainValidator</span><span class="p">(),</span>
                           <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">Email</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">))</span>
    <span class="sd">&quot;&quot;&quot;Updated e-mail address&quot;&quot;&quot;</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">UnicodeString</span><span class="p">(</span><span class="n">not_empty</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="sd">&quot;&quot;&quot;Updated name&quot;&quot;&quot;</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">formencode</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">UnicodeString</span><span class="p">()</span>
    <span class="sd">&quot;&quot;&quot;Updated password&quot;&quot;&quot;</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;user.edit&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;wte:templates/users/edit.kajiki&#39;</span><span class="p">)</span>
<span class="nd">@current_user</span><span class="p">()</span>
<span class="nd">@require_logged_in</span><span class="p">()</span>
<div class="viewcode-block" id="edit"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.edit">[docs]</a><span class="k">def</span> <span class="nf">edit</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles the &quot;/users/{uid}/edit&quot; URL, providing the form and backend</span>
<span class="sd">    functionality to update the user&#39;s profile.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s1">&#39;edit&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="p">):</span>
            <span class="n">crumbs</span> <span class="o">=</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                                   <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span>
                                                  <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Edit&#39;</span><span class="p">,</span>
                                                   <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.edit&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)}])</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">params</span> <span class="o">=</span> <span class="n">EditSchema</span><span class="p">()</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                                                    <span class="n">State</span><span class="p">(</span><span class="n">dbsession</span><span class="o">=</span><span class="n">dbsession</span><span class="p">,</span>
                                                          <span class="n">userid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                                                          <span class="n">email_domains</span><span class="o">=</span><span class="n">get_config_setting</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                                                                           <span class="n">key</span><span class="o">=</span><span class="s1">&#39;registration.domains&#39;</span><span class="p">,</span>
                                                                                           <span class="n">target_type</span><span class="o">=</span><span class="s1">&#39;list&#39;</span><span class="p">,</span>
                                                                                           <span class="n">default</span><span class="o">=</span><span class="bp">None</span><span class="p">),</span>
                                                          <span class="n">user_class</span><span class="o">=</span><span class="n">User</span><span class="p">,</span>
                                                          <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">))</span>
                    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
                        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                        <span class="n">user</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;email&#39;</span><span class="p">]</span>
                        <span class="n">user</span><span class="o">.</span><span class="n">display_name</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]:</span>
                            <span class="n">user</span><span class="o">.</span><span class="n">new_password</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">])</span>
                    <span class="k">raise</span> <span class="n">HTTPSeeOther</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">]))</span>
                <span class="k">except</span> <span class="n">formencode</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;e&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_dict</span><span class="p">,</span>
                            <span class="s1">&#39;values&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
                            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                            <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">crumbs</span><span class="p">,</span>
                            <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;profile.html&#39;</span><span class="p">]}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                    <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">crumbs</span><span class="p">,</span>
                    <span class="s1">&#39;help&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="s1">&#39;profile.html&#39;</span><span class="p">]}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unauthorised_redirect</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;user.permissions&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;wte:templates/users/permissions.kajiki&#39;</span><span class="p">)</span>
<span class="nd">@current_user</span><span class="p">()</span>
<span class="nd">@require_logged_in</span><span class="p">()</span>
<div class="viewcode-block" id="permissions"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.permissions">[docs]</a><span class="k">def</span> <span class="nf">permissions</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles the &quot;/users/{uid}/permissions&quot; URL, providing the form and</span>
<span class="sd">    backend functionality for setting the :class:`~wte.models.Permission` and</span>
<span class="sd">    :class:`~wte.models.PermissionGroup` that the :class:`~wte.models.User`</span>
<span class="sd">    belongs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;admin.users.permissions&#39;</span><span class="p">):</span>
        <span class="n">dbsession</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
        <span class="n">user</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
            <span class="n">permission_groups</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PermissionGroup</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">PermissionGroup</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="n">permissions</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Permission</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">CSRFSchema</span><span class="p">(</span><span class="n">allow_extra_fields</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">State</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">))</span>
                    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
                        <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="s1">&#39;permission_group&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                            <span class="n">user</span><span class="o">.</span><span class="n">permission_groups</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">PermissionGroup</span><span class="p">)</span><span class="o">.</span>\
                                <span class="nb">filter</span><span class="p">(</span><span class="n">PermissionGroup</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">user</span><span class="o">.</span><span class="n">permission_groups</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="n">ids</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">getall</span><span class="p">(</span><span class="s1">&#39;permission&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ids</span><span class="p">:</span>
                            <span class="n">user</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Permission</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">id</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">user</span><span class="o">.</span><span class="n">permissions</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                    <span class="n">dbsession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;admin.users.view&#39;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">HTTPSeeOther</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPSeeOther</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;users.view&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_dict</span><span class="p">,</span>
                            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                            <span class="s1">&#39;permission_groups&#39;</span><span class="p">:</span> <span class="n">permission_groups</span><span class="p">,</span>
                            <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">permissions</span><span class="p">,</span>
                            <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                                                    <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span>
                                                                                             <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span>
                                                                   <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Permissions&#39;</span><span class="p">,</span>
                                                                    <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.permissions&#39;</span><span class="p">,</span>
                                                                                             <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)}])}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                    <span class="s1">&#39;permission_groups&#39;</span><span class="p">:</span> <span class="n">permission_groups</span><span class="p">,</span>
                    <span class="s1">&#39;permissions&#39;</span><span class="p">:</span> <span class="n">permissions</span><span class="p">,</span>
                    <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                                            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span>
                                                                                     <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span>
                                                           <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Permissions&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.permissions&#39;</span><span class="p">,</span>
                                                                                     <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)}])}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">unauthorised_redirect</span><span class="p">(</span><span class="n">request</span><span class="p">)</span></div>


<span class="nd">@view_config</span><span class="p">(</span><span class="n">route_name</span><span class="o">=</span><span class="s1">&#39;user.delete&#39;</span><span class="p">,</span> <span class="n">renderer</span><span class="o">=</span><span class="s1">&#39;wte:templates/users/delete.kajiki&#39;</span><span class="p">)</span>
<span class="nd">@current_user</span><span class="p">()</span>
<span class="nd">@require_logged_in</span><span class="p">()</span>
<div class="viewcode-block" id="delete"><a class="viewcode-back" href="../../../api/wte_views_user.html#wte.views.user.delete">[docs]</a><span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Handles the &quot;/users/{uid}/delete&quot; URL, providing the form and backend</span>
<span class="sd">    functionality for deleting a :class:`~wte.models.User`. Also deletes all</span>
<span class="sd">    the data that is linked to that :class:`~wte.models.User`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dbsession</span> <span class="o">=</span> <span class="n">DBSession</span><span class="p">()</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">dbsession</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">request</span><span class="o">.</span><span class="n">matchdict</span><span class="p">[</span><span class="s1">&#39;uid&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">user</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user</span><span class="o">.</span><span class="n">allow</span><span class="p">(</span><span class="s1">&#39;delete&#39;</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">CSRFSchema</span><span class="p">()</span><span class="o">.</span><span class="n">to_python</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">State</span><span class="p">(</span><span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">))</span>
                    <span class="k">with</span> <span class="n">transaction</span><span class="o">.</span><span class="n">manager</span><span class="p">:</span>
                        <span class="n">dbsession</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
                    <span class="n">request</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">flash</span><span class="p">(</span><span class="s1">&#39;The account has been deleted&#39;</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="s1">&#39;info&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="s1">&#39;admin.users.view&#39;</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="n">HTTPSeeOther</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">HTTPSeeOther</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;root&#39;</span><span class="p">))</span>
                <span class="k">except</span> <span class="n">formencode</span><span class="o">.</span><span class="n">Invalid</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;errors&#39;</span><span class="p">:</span> <span class="n">e</span><span class="o">.</span><span class="n">error_dict</span><span class="p">,</span>
                            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                            <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span>
                                                         <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                                           <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span>
                                                          <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Delete&#39;</span><span class="p">,</span>
                                                           <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.delete&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)}])}</span>
            <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="n">user</span><span class="p">,</span>
                    <span class="s1">&#39;crumbs&#39;</span><span class="p">:</span> <span class="n">create_user_crumbs</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="p">[{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">user</span><span class="o">.</span><span class="n">display_name</span><span class="p">,</span>
                                                            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.view&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)},</span>
                                                           <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="s1">&#39;Delete&#39;</span><span class="p">,</span>
                                                            <span class="s1">&#39;url&#39;</span><span class="p">:</span> <span class="n">request</span><span class="o">.</span><span class="n">route_url</span><span class="p">(</span><span class="s1">&#39;user.delete&#39;</span><span class="p">,</span> <span class="n">uid</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)}])}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">unauthorised_redirect</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">HTTPNotFound</span><span class="p">()</span></div>
</pre></div>
        </div>
      </div>
      <ul class="pagination text-center" role="navigation" aria-label="Pagination">
        
        
      </ul>
    </nav>
  </body>
</html>